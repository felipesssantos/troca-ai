name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prd

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Add set -e to stop script execution on error
          set -e

          # 1. Navigate to project directory (Adjust path as needed)
          mkdir -p ~/troca-ai
          cd ~/troca-ai

          # 2. Pull latest changes (Using git or rsync if not a git repo on server)
          # Assuming the server has the repo cloned already. If not, you might need to clone first.
          # Ideally: git pull origin main
          # For simplicity in this script, let's assume we maintain the state via git on the server.
          
          if [ ! -d ".git" ]; then
            git clone https://github.com/${{ github.repository }}.git .
          fi

          git pull origin main

          # 3. Create .env file from Secrets
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" > .env
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}" >> .env
          echo "VITE_MINIO_ENDPOINT=${{ secrets.VITE_MINIO_ENDPOINT }}" >> .env
          echo "VITE_MINIO_ACCESS_KEY=${{ secrets.VITE_MINIO_ACCESS_KEY }}" >> .env
          echo "VITE_MINIO_SECRET_KEY=${{ secrets.VITE_MINIO_SECRET_KEY }}" >> .env
          
          # 4. Build and Run (Using raw Docker to avoid Compose dependency)
          # Load secrets into shell variables for build args
          export VITE_SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          export VITE_SUPABASE_ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}"
          export VITE_MINIO_ENDPOINT="${{ secrets.VITE_MINIO_ENDPOINT }}"
          export VITE_MINIO_ACCESS_KEY="${{ secrets.VITE_MINIO_ACCESS_KEY }}"
          export VITE_MINIO_SECRET_KEY="${{ secrets.VITE_MINIO_SECRET_KEY }}"

          echo "Building Docker Image..."
          docker build \
            --build-arg VITE_SUPABASE_URL="$VITE_SUPABASE_URL" \
            --build-arg VITE_SUPABASE_ANON_KEY="$VITE_SUPABASE_ANON_KEY" \
            --build-arg VITE_MINIO_ENDPOINT="$VITE_MINIO_ENDPOINT" \
            --build-arg VITE_MINIO_ACCESS_KEY="$VITE_MINIO_ACCESS_KEY" \
            --build-arg VITE_MINIO_SECRET_KEY="$VITE_MINIO_SECRET_KEY" \
            -t troca-ai-app .

          echo "Stopping old container..."
          docker stop troca-ai-app || true
          docker rm troca-ai-app || true

          echo "Starting new container..."
          docker run -d \
            --name troca-ai-app \
            -p 80:80 \
            --restart always \
            troca-ai-app

          # 5. Cleanup
          docker image prune -f
